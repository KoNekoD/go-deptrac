services:
  - class: Internal\Qossmic\Deptrac\IgnoreDependenciesOnContract
    tags:
     - { name: kernel.event_subscriber }

deptrac:
  paths:
    - ./pkg/src

  analyser:
    internal_tag: "@internal"
    types:
      - class
      - class_superglobal
      - file
      - function
      - function_superglobal
      - function_call

  formatters:
    graphviz:
      pointToGroups: true
      groups:
        Contract:
          - Contract
        Supportive:
          - Supportive
          - File
          - Time
          - DependencyInjection
          - OutputFormatter
          - Symfony
        Core:
          - Analyser
          - Ast
          - Dependency
          - InputCollector
          - Layer

  layers:
    # Domains
    - name: Analyser
      collectors:
        - type: directory
          value: pkg/src/core/analyser/.*
    - name: Ast
      collectors:
        - type: directory
          value: pkg/src/core/ast/.*
        - type: composer
          private: true
          composerPath: composer.json
          composerLockPath: composer.lock
          packages:
            - phpstan/phpdoc-parser
            - nikic/php-parser
            - phpdocumentor/type-resolver
    - name: Console
      collectors:
        - type: directory
          value: pkg/src/supportive/console/.*
    - name: Dependency
      collectors:
        - type: directory
          value: pkg/src/core/dependency/.*
    - name: DependencyInjection
      collectors:
        - type: directory
          value: pkg/src/supportive/dependency_injection/.*
    - name: Contract
      collectors:
        - type: directory
          value: pkg/src/contract/.*
    - name: InputCollector
      collectors:
        - type: directory
          value: pkg/src/core/input_collector/.*
    - name: Layer
      collectors:
        - type: directory
          value: pkg/src/core/layer/.*
    - name: OutputFormatter
      collectors:
        - type: directory
          value: pkg/src/supportive/output_formatter/.*
        - type: composer
          private: true
          composerPath: composer.json
          composerLockPath: composer.lock
          packages:
            - phpdocumentor/graphviz
    - name: File
      collectors:
        - type: directory
          value: pkg/src/supportive/file/.*
    - name: Time
      collectors:
        - type: directory
          value: pkg/src/supportive/time/.*
    - name: Supportive
      collectors:
        - type: bool
          must_not:
            - type: directory
              value: pkg/src/supportive/.*/.*
          must:
            - type: directory
              value: pkg/src/supportive/.*
    - name: Symfony
      collectors:
        - type: composer
          composerPath: composer.json
          composerLockPath: composer.lock
          packages:
            - symfony/config
            - symfony/console
            - symfony/dependency-injection
            - symfony/event-dispatcher
            - symfony/filesystem
            - symfony/finder
            - symfony/yaml

  ruleset:
    Layer:
      - Ast
      - Symfony
      - Contract
    Console:
      - Analyser
      - OutputFormatter
      - DependencyInjection
      - File
      - Time
      - Symfony
      - Contract
    Dependency:
      - Ast
      - Contract
    Analyser:
      - Layer
      - Dependency
      - Ast
      - Symfony
      - Contract
    OutputFormatter:
      - DependencyInjection
      - Symfony
      - Contract
    Ast:
      - File
      - InputCollector
      - Symfony
      - Contract
    InputCollector:
      - File
      - Symfony
    DependencyInjection:
      - Symfony
      - Console
      - Contract
    Contract:
      - Symfony
    File:
      - Symfony
